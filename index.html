<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230a0e1a'/><path d='M25 60 L50 30 L75 50 L75 40 L50 20 L25 50 L25 70 L75 70 L75 60' fill='%2300d4ff' stroke='%2300d4ff' stroke-width='2' stroke-linejoin='round'/></svg>">
    
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #131823;
            --bg-card: #1a1f2e;
            --text-primary: #e4e6eb;
            --text-secondary: #8892b0;
            --accent: #00d4ff;
            --accent-hover: #00a8cc;
            --accent-gradient: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            --border: rgba(255, 255, 255, 0.08);
            --danger: #ff5555;
            --success: #50fa7b;
            --warning: #ffb86c;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        /* Login - Mobile First */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
            padding: 1rem;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 2rem 1.5rem;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .login-box h1 {
            margin-bottom: 1.5rem;
            font-weight: 600;
            text-align: center;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.75rem;
        }

        .login-input {
            width: 100%;
            padding: 0.875rem;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 1.25rem;
            transition: all 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .login-button {
            width: 100%;
            padding: 0.875rem;
            background: var(--accent-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }

        .error {
            color: var(--danger);
            text-align: center;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* Dashboard - Mobile First */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: var(--bg-primary);
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-weight: 600;
            font-size: 1.25rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logout-btn {
            background: var(--danger);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #ff3333;
            transform: translateY(-2px);
        }

        .container {
            padding: 1rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Tabs - Mobile First */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            background: var(--bg-card);
            padding: 0.375rem;
            border-radius: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 0.625rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .tab.active {
            background: var(--accent-gradient);
            color: white;
        }

        /* Stats Cards - Mobile First */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Security Badges */
        .security-badge {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 600;
            margin: 0.125rem;
        }

        .badge-threat { background: var(--danger); color: white; }
        .badge-tor { background: var(--warning); color: black; }
        .badge-proxy { background: #8b5cf6; color: white; }
        .badge-crawler { background: #3b82f6; color: white; }
        .badge-normal { background: var(--text-secondary); color: white; }

        /* Charts - Mobile First */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--text-primary);
        }

        #map {
            height: 300px;
            border-radius: 8px;
            margin-top: 0.75rem;
        }

        .leaflet-control-attribution,
        .leaflet-control-zoom {
            display: none !important;
        }

        /* Table - Mobile First */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 0.75rem;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: var(--bg-secondary);
            color: var(--accent);
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 0.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 0.625rem 0.5rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.8125rem;
            color: var(--text-primary);
        }

        tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .expandable {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }

        .expandable:hover {
            color: var(--accent);
        }

        .expanded {
            white-space: normal;
            word-break: break-word;
            max-width: none;
            background: var(--bg-secondary);
            padding: 0.375rem;
            border-radius: 4px;
        }

        /* Pagination - Mobile First */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .page-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 0.875rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--accent-gradient);
            border-color: transparent;
            transform: translateY(-2px);
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-info {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
        }

        /* Filters - Mobile First */
        .filters {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .filter-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-input {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* File Manager - Mobile First */
        .file-manager {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .file-upload {
            background: var(--bg-secondary);
            border: 2px dashed var(--accent);
            border-radius: 12px;
            padding: 1.5rem 1rem;
            text-align: center;
            margin: 1rem 0;
            transition: all 0.3s;
        }

        .file-upload:hover {
            background: rgba(0, 212, 255, 0.05);
            border-color: var(--accent-hover);
        }

        .file-upload-input {
            display: none;
        }

        .file-upload-label {
            display: inline-block;
            padding: 0.625rem 1.25rem;
            background: var(--accent-gradient);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }

        .file-upload-text {
            margin-top: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Buttons - Mobile First */
        .btn {
            background: var(--accent-gradient);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-small {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
        }

        /* Tablet and up */
        @media (min-width: 768px) {
            .login-box {
                padding: 3rem;
            }

            .login-box h1 {
                font-size: 2rem;
                margin-bottom: 2rem;
            }

            .login-input {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }

            .login-button {
                padding: 1rem;
            }

            .header {
                padding: 1.5rem 2rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .logout-btn {
                padding: 0.6rem 1.5rem;
                font-size: 1rem;
            }

            .container {
                padding: 1.5rem;
            }

            .tabs {
                gap: 0.5rem;
                padding: 0.5rem;
                margin-bottom: 1.5rem;
            }

            .tab {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .stat-card {
                padding: 1.25rem;
            }

            .stat-value {
                font-size: 2.25rem;
            }

            .stat-label {
                font-size: 0.85rem;
                margin-top: 0.375rem;
            }

            .filters {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                padding: 1.25rem;
                margin-bottom: 1.5rem;
            }

            .filter-group {
                gap: 0.5rem;
            }

            .filter-label {
                font-size: 0.85rem;
            }

            .filter-input {
                padding: 0.6rem;
                font-size: 1rem;
            }

            .chart-container {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
            }

            .chart-title {
                font-size: 1.1rem;
                margin-bottom: 1rem;
            }

            #map {
                height: 350px;
                margin-top: 1rem;
            }

            .table-container {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
            }

            .table-wrapper {
                margin-top: 1rem;
            }

            th {
                padding: 0.875rem;
                font-size: 0.85rem;
            }

            td {
                padding: 0.75rem;
                font-size: 0.875rem;
            }

            .expandable {
                max-width: 250px;
            }

            .pagination {
                gap: 0.75rem;
                margin: 1.5rem 0;
            }

            .page-btn {
                padding: 0.6rem 1.2rem;
                font-size: 1rem;
            }

            .page-info {
                font-size: 1rem;
            }

            .btn {
                padding: 0.6rem 1.5rem;
                font-size: 1rem;
            }

            .btn-small {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
        }

        /* Desktop */
        @media (min-width: 1024px) {
            .container {
                padding: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .stat-value {
                font-size: 2.5rem;
            }

            .stat-label {
                font-size: 0.9rem;
                margin-top: 0.5rem;
                letter-spacing: 1px;
            }

            .filters {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                padding: 1.5rem;
                margin-bottom: 2rem;
            }

            .chart-container {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            #map {
                height: 400px;
            }

            .table-container {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            table {
                min-width: 1400px;
            }

            th {
                padding: 1rem;
            }

            td {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .expandable {
                max-width: 300px;
            }

            .pagination {
                gap: 1rem;
                margin: 2rem 0;
            }

            .file-manager {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .file-upload {
                padding: 2rem;
                margin: 1.5rem 0;
            }

            .file-upload-label {
                padding: 0.8rem 2rem;
                font-size: 1rem;
            }

            .file-upload-text {
                margin-top: 1rem;
                font-size: 1rem;
            }
        }

        /* Security badge adjustments for mobile */
        @media (max-width: 767px) {
            .security-badge {
                font-size: 0.5rem;
                padding: 0.1rem 0.25rem;
                margin: 0.05rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>Analytics Dashboard</h1>
            <input type="password" class="login-input" id="passwordInput" placeholder="Enter password" autocomplete="off">
            <button class="login-button" onclick="login()">Access Dashboard</button>
            <div class="error" id="loginError"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>Analytics Dashboard</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('visits')">All Websites</button>
                <button class="tab" onclick="switchTab('queries')">Homepage Queries</button>
                <button class="tab" onclick="switchTab('files')">File Manager</button>
            </div>

            <!-- Filters -->
            <div class="filters" id="filtersSection">
                <div class="filter-group" id="sourceFilterGroup">
                    <label class="filter-label">Source</label>
                    <select class="filter-input" id="sourceFilter">
                        <option value="">All Sources</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">IP Address</label>
                    <input type="text" class="filter-input" id="ipFilter" placeholder="Filter by IP">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Country</label>
                    <select class="filter-input" id="countryFilter">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Referer</label>
                    <select class="filter-input" id="refererFilter">
                        <option value="">All Referers</option>   
                   </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Date From</label>
                    <input type="date" class="filter-input" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Date To</label>
                    <input type="date" class="filter-input" id="dateTo">
                </div>
                <div class="filter-group">
                    <label class="filter-label">&nbsp;</label>
                    <button class="btn" onclick="applyFilters()">Apply Filters</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalEntries">0</div>
                    <div class="stat-label">Total Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueIPs">0</div>
                    <div class="stat-label">Unique IPs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="countries">0</div>
                    <div class="stat-label">Countries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">Today's Activity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="threats">0</div>
                    <div class="stat-label">Threats Detected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="crawlers">0</div>
                    <div class="stat-label">Crawlers/Bots</div>
                </div>
            </div>

            <!-- Data Table (AT TOP) -->
            <div class="table-container" id="dataTableContainer">
                <h3 class="chart-title">Detailed Data</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr id="tableHeaders"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="pagination">
                    <button class="page-btn" id="prevBtn" onclick="changePage(-1)">← Previous</button>
                    <span class="page-info" id="pageInfo">Page 1 of 1</span>
                    <button class="page-btn" id="nextBtn" onclick="changePage(1)">Next →</button>
                </div>
            </div>

            <!-- Charts (BELOW TABLE) -->
            <div id="chartsSection">
                <div class="chart-container">
                    <h3 class="chart-title">Activity Over Time</h3>
                    <canvas id="activityChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Global Visitor Map</h3>
                    <div id="map"></div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Top Countries</h3>
                    <canvas id="countriesChart"></canvas>
                </div>
            </div>

            <!-- File Manager -->
            <div class="file-manager" id="fileManager">
                <h3 class="chart-title">Storage Files</h3>
                <div class="file-upload">
                    <input type="file" id="fileInput" class="file-upload-input" accept=".csv,.json,.txt">
                    <label for="fileInput" class="file-upload-label">Choose File</label>
                    <div class="file-upload-text" id="fileUploadText">Or drag and drop a file here</div>
                    <button class="btn" onclick="uploadFile()" style="margin-top: 1rem; display: none;" id="uploadBtn">Upload File</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Size</th>
                                <th>Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="filesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    // Configuration
    const API_URL = 'https://api.reisig.org';
    let authToken = null;
    let currentTab = 'visits';
    let currentPage = 1;
    let totalPages = 1;
    let allData = [];
    let filteredData = [];
    let charts = {};
    let map = null;

    // CORRECTED: Source mapping to show proper display names
    const SOURCE_DISPLAY_MAPPING = {
        'delphiweis': 'Delphiweis',
        'rheinfallspinsel': 'Rheinfallspinsel', 
        'map-rfp': 'Map RFP',
        'any': 'Any',
        'qorra': 'Qorra',
        'reisig.org': 'Reisig.org',
        'stars-api': 'Stars API' // Add any other sources you have
    };

    function getSourceDisplayName(source) {
        return SOURCE_DISPLAY_MAPPING[source] || source || 'Unknown';
    }

    // File upload handling
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('fileUploadText').textContent = `Selected: ${file.name}`;
            document.getElementById('uploadBtn').style.display = 'inline-block';
        }
    });

    // Authentication
    document.getElementById('passwordInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') login();
    });

    async function login() {
        const password = document.getElementById('passwordInput').value;
        const errorDiv = document.getElementById('loginError');
        
        try {
            const response = await fetch(`${API_URL}/monitor/auth`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });

            if (response.ok) {
                const data = await response.json();
                authToken = data.token;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadData();
            } else {
                errorDiv.textContent = 'Invalid password';
            }
        } catch (error) {
            errorDiv.textContent = 'Connection error: ' + error.message;
        }
    }

    function logout() {
        authToken = null;
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('passwordInput').value = '';
    }

    // Tab switching
    function switchTab(tab) {
        currentTab = tab;
        currentPage = 1;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        // Show/hide source filter for queries tab
        const sourceFilterGroup = document.getElementById('sourceFilterGroup');
        if (tab === 'queries') {
            sourceFilterGroup.style.display = 'none';
        } else {
            sourceFilterGroup.style.display = 'flex';
        }
        
        // Show/hide sections
        if (tab === 'files') {
            document.getElementById('fileManager').style.display = 'block';
            document.getElementById('chartsSection').style.display = 'none';
            document.getElementById('dataTableContainer').style.display = 'none';
            document.getElementById('statsGrid').style.display = 'none';
            document.getElementById('filtersSection').style.display = 'none';
            loadFiles();
        } else {
            document.getElementById('fileManager').style.display = 'none';
            document.getElementById('chartsSection').style.display = 'block';
            document.getElementById('dataTableContainer').style.display = 'block';
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('filtersSection').style.display = 'grid';
            loadData();
        }
    }

    // Apply filters
    async function applyFilters() {
        currentPage = 1;
        await loadData();
    }

    // Change page
    function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            updateTable(filteredData);
            updatePagination();
        }
    }

    // Update source filter dropdown
    function updateSourceFilter(data) {
        const sourceFilter = document.getElementById('sourceFilter');
        const currentValue = sourceFilter.value;
        
        const sources = new Set();
        data.forEach(entry => {
            if (entry.source && entry.source.trim() !== '') {
                sources.add(entry.source);
            }
        });
        
        const sortedSources = Array.from(sources).sort((a, b) => 
            getSourceDisplayName(a).toLowerCase().localeCompare(getSourceDisplayName(b).toLowerCase())
        );
        
        sourceFilter.innerHTML = '<option value="">All Sources</option>';
        
        sortedSources.forEach(source => {
            const option = document.createElement('option');
            option.value = source;
            option.textContent = getSourceDisplayName(source);
            sourceFilter.appendChild(option);
        });
        
        if (currentValue && sortedSources.includes(currentValue)) {
            sourceFilter.value = currentValue;
        }
    }

    // NEW: Update referer filter dropdown
    function updateRefererFilter(data) {
        const refererFilter = document.getElementById('refererFilter');
        const currentValue = refererFilter.value;
        
        const referers = new Set();
        data.forEach(entry => {
            if (entry.referer && entry.referer.trim() !== '' && entry.referer !== 'direct') {
                // Extract domain from referer URL
                try {
                    const url = new URL(entry.referer);
                    referers.add(url.hostname);
                } catch {
                    referers.add(entry.referer);
                }
            }
        });
        
        const sortedReferers = Array.from(referers).sort();
        
        refererFilter.innerHTML = '<option value="">All Referers</option>';
        
        sortedReferers.forEach(referer => {
            const option = document.createElement('option');
            option.value = referer;
            option.textContent = referer;
            refererFilter.appendChild(option);
        });
        
        if (currentValue && sortedReferers.includes(currentValue)) {
            refererFilter.value = currentValue;
        }
    }

    // Update country filter dropdown
    function updateCountryFilter(data) {
        const countryFilter = document.getElementById('countryFilter');
        const currentValue = countryFilter.value;
        
        const countries = new Set();
        data.forEach(entry => {
            if (entry.country && entry.country.trim() !== '' && 
                entry.country !== 'Unknown' && entry.country !== 'Error' && entry.country !== 'Local') {
                countries.add(entry.country);
            }
        });
        
        const sortedCountries = Array.from(countries).sort();
        
        countryFilter.innerHTML = '<option value="">All Countries</option>';
        
        sortedCountries.forEach(country => {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            countryFilter.appendChild(option);
        });
        
        if (currentValue && sortedCountries.includes(currentValue)) {
            countryFilter.value = currentValue;
        }
    }

    // Update dashboard
    function updateDashboard(data) {
        const uniqueIPs = new Set();
        const countriesSet = new Set();
        const dailyActivity = new Map();
        const today = new Date().toDateString();
        let todayCount = 0;
        let threatCount = 0;
        let crawlerCount = 0;

        data.forEach(entry => {
            uniqueIPs.add(entry.ip);
            if (entry.country && entry.country !== 'Unknown' && entry.country !== 'Error' && entry.country !== 'Local') {
                countriesSet.add(entry.country);
            }
            
            const date = new Date(entry.timestamp).toLocaleDateString();
            dailyActivity.set(date, (dailyActivity.get(date) || 0) + 1);
            
            if (new Date(entry.timestamp).toDateString() === today) {
                todayCount++;
            }
            
            if (entry.is_threat === 'true' || entry.is_threat === true) threatCount++;
            if (entry.is_crawler === 'true' || entry.is_crawler === true) crawlerCount++;
        });

        // Update stats
        document.getElementById('totalEntries').textContent = data.length.toLocaleString();
        document.getElementById('uniqueIPs').textContent = uniqueIPs.size.toLocaleString();
        document.getElementById('countries').textContent = countriesSet.size.toLocaleString();
        document.getElementById('todayCount').textContent = todayCount.toLocaleString();
        document.getElementById('threats').textContent = threatCount.toLocaleString();
        document.getElementById('crawlers').textContent = crawlerCount.toLocaleString();

        // Update charts
        updateActivityChart(dailyActivity);
        updateCountriesChart(data);
        updateMap(data);
    }

    // Activity chart
    function updateActivityChart(dailyActivity) {
        const ctx = document.getElementById('activityChart').getContext('2d');
        
        if (charts.activity) charts.activity.destroy();
        
        const sortedDates = Array.from(dailyActivity.keys()).sort((a, b) => 
            new Date(a) - new Date(b)
        );
        const labels = sortedDates.slice(-30);
        const data = labels.map(label => dailyActivity.get(label));

        charts.activity = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Activity',
                    data,
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { 
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#8892b0' }
                    },
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { 
                            color: '#8892b0',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    // Countries chart
    function updateCountriesChart(data) {
        const ctx = document.getElementById('countriesChart').getContext('2d');
        
        if (charts.countries) charts.countries.destroy();
        
        const countries = {};
        data.forEach(entry => {
            if (entry.country && entry.country !== 'Unknown' && entry.country !== 'Error' && entry.country !== 'Local') {
                countries[entry.country] = (countries[entry.country] || 0) + 1;
            }
        });
        
        const sorted = Object.entries(countries)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

        charts.countries = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(([country]) => country),
                datasets: [{
                    label: 'Entries',
                    data: sorted.map(([, count]) => count),
                    backgroundColor: 'rgba(0, 212, 255, 0.8)',
                    borderColor: 'rgba(0, 212, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { 
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#8892b0' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#8892b0' }
                    }
                }
            }
        });
    }

    // Map
    function updateMap(data) {
        if (map) map.remove();
        
        map = L.map('map', {
            attributionControl: false,
            zoomControl: false
        }).setView([30, 0], 2);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const locations = {};
        data.forEach(entry => {
            if (entry.latitude && entry.longitude && 
                entry.latitude !== '0' && entry.longitude !== '0') {
                const key = `${entry.latitude},${entry.longitude}`;
                if (!locations[key]) {
                    locations[key] = {
                        lat: parseFloat(entry.latitude),
                        lng: parseFloat(entry.longitude),
                        city: entry.city,
                        country: entry.country,
                        count: 0,
                        ips: new Set(),
                        threats: 0,
                        crawlers: 0
                    };
                }
                locations[key].count++;
                locations[key].ips.add(entry.ip);
                if (entry.is_threat === 'true' || entry.is_threat === true) locations[key].threats++;
                if (entry.is_crawler === 'true' || entry.is_crawler === true) locations[key].crawlers++;
            }
        });

        Object.values(locations).forEach(loc => {
            const color = loc.threats > 0 ? '#ff5555' : '#00d4ff';
            const marker = L.circleMarker([loc.lat, loc.lng], {
                radius: Math.min(5 + Math.log(loc.count) * 2, 20),
                fillColor: color,
                color: '#fff',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.6
            }).addTo(map);
            
            marker.bindPopup(`
                <strong>${loc.city || 'Unknown'}, ${loc.country || 'Unknown'}</strong><br>
                Entries: ${loc.count}<br>
                Unique IPs: ${loc.ips.size}<br>
                ${loc.threats > 0 ? `<span style="color: #ff5555">Threats: ${loc.threats}</span><br>` : ''}
                ${loc.crawlers > 0 ? `Crawlers: ${loc.crawlers}` : ''}
            `);
        });
    }

    // Update table - FIXED with proper security badges
    function updateTable(data) {
        const headers = document.getElementById('tableHeaders');
        const body = document.getElementById('tableBody');
        
        if (currentTab === 'visits') {
            headers.innerHTML = `
                <th>Timestamp</th>
                <th>City</th>
                <th>Region</th>
                <th>Country</th>
                <th>Source</th>
                <th>Referer</th>
                <th>Language</th>
                <th>IP</th>
                <th>User Agent</th>
                <th>Security</th>
            `;
        } else {
            headers.innerHTML = `
                <th>Timestamp</th>
                <th>City</th>
                <th>Region</th>
                <th>Country</th>
                <th>Language</th>
                <th>IP</th>
                <th>Security</th>
                <th>Query</th>
                <th>Response</th>
            `;
        }
        
        body.innerHTML = '';
        
        const sortedData = [...data].sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
        );
        
        const itemsPerPage = 50;
        totalPages = Math.ceil(sortedData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = sortedData.slice(startIndex, endIndex);
        
        pageData.forEach(entry => {
            const row = body.insertRow();
            
            // FIXED: Create security badges with postal code
            let securityBadges = '';
            let hasSecurityIssue = false;
            
            if (entry.is_threat === 'true' || entry.is_threat === true) {
                securityBadges += '<span class="security-badge badge-threat">THREAT</span>';
                hasSecurityIssue = true;
            }
            if (entry.is_tor === 'true' || entry.is_tor === true) {
                securityBadges += '<span class="security-badge badge-tor">TOR</span>';
                hasSecurityIssue = true;
            }
            if (entry.is_proxy === 'true' || entry.is_proxy === true) {
                securityBadges += '<span class="security-badge badge-proxy">PROXY</span>';
                hasSecurityIssue = true;
            }
            if (entry.is_crawler === 'true' || entry.is_crawler === true) {
                securityBadges += '<span class="security-badge badge-crawler">CRAWLER</span>';
                hasSecurityIssue = true;
            }
            
            if (!hasSecurityIssue) {
                securityBadges = '<span class="security-badge badge-normal">NORMAL</span>';
            }
            
            // Add postal code if available
            if (entry.postal_code) {
                securityBadges += `<br><small>ZIP: ${entry.postal_code}</small>`;
            }
            
            if (currentTab === 'visits') {
                row.innerHTML = `
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>${entry.city || ''}</td>
                    <td>${entry.region || ''}</td>
                    <td>${entry.country || ''} ${entry.country_code ? `(${entry.country_code})` : ''}</td>
                    <td>${getSourceDisplayName(entry.source)}</td>
                    <td class="expandable" onclick="toggleExpand(this)">${entry.referer || ''}</td>
                    <td class="expandable" onclick="toggleExpand(this)">${entry.language || ''}</td>
                    <td>${entry.ip || ''}</td>
                    <td class="expandable" onclick="toggleExpand(this)">${entry.user_agent || ''}</td>
                    <td>${securityBadges}</td>
                `;
            } else {
                row.innerHTML = `
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>${entry.city || ''}</td>
                    <td>${entry.region || ''}</td>
                    <td>${entry.country || ''} ${entry.country_code ? `(${entry.country_code})` : ''}</td>
                    <td class="expandable" onclick="toggleExpand(this)">${entry.language || ''}</td>
                    <td>${entry.ip || ''}</td>
                    <td>${securityBadges}</td>
                    <td class="expandable" onclick="toggleExpand(this)">${entry.query || ''}</td>
                    <td class="expandable" onclick="toggleExpand(this)">${entry.response || ''}</td>
                `;
            }
        });
    }

    function toggleExpand(cell) {
        cell.classList.toggle('expanded');
    }

    function updatePagination() {
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    // Load data
    async function loadData() {
        try {
            const sourceFilter = document.getElementById('sourceFilter').value;
            const ipFilter = document.getElementById('ipFilter').value;
            const countryFilter = document.getElementById('countryFilter').value;
            const refererFilter = document.getElementById('refererFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            const params = new URLSearchParams({
                token: authToken,
                type: currentTab,
                limit: 100000
            });

            if (sourceFilter) params.append('source', sourceFilter);
            if (ipFilter) params.append('ip', ipFilter);
            if (countryFilter) params.append('country', countryFilter);
            if (refererFilter) params.append('referer', refererFilter);
            if (dateFrom) params.append('start', dateFrom);
            if (dateTo) params.append('end', dateTo);

            const response = await fetch(`${API_URL}/monitor/data?${params}`);
            if (!response.ok) throw new Error('Failed to fetch data');
            
            const result = await response.json();
            allData = result.data || [];
            
            // Load unfiltered data for dropdowns
            const unfilteredParams = new URLSearchParams({
                token: authToken,
                type: currentTab,
                limit: 100000
            });
            
            const unfilteredResponse = await fetch(`${API_URL}/monitor/data?${unfilteredParams}`);
            const unfilteredResult = await unfilteredResponse.json();
            const unfilteredData = unfilteredResult.data || [];
            
            if (currentTab === 'visits') {
                updateSourceFilter(unfilteredData);
                updateRefererFilter(unfilteredData);
            }
            updateCountryFilter(unfilteredData);
            
            filteredData = allData;
            
            updateDashboard(filteredData);
            updateTable(filteredData);
            updatePagination();
        } catch (error) {
            console.error('Error loading data:', error);
            allData = [];
            filteredData = [];
            updateDashboard([]);
            updateTable([]);
            updatePagination();
        }
    }

 // File management functions
async function loadFiles() {
    try {
        const response = await fetch(`${API_URL}/monitor/files?token=${authToken}`);
        if (!response.ok) throw new Error('Failed to fetch files');
        
        const files = await response.json();
        const tbody = document.getElementById('filesTableBody');
        tbody.innerHTML = '';
        
        files.forEach(file => {
            const row = tbody.insertRow();
            const sizeKB = (file.size / 1024).toFixed(2);
            const modified = new Date(file.modified).toLocaleString();
            
            // Style hidden files differently
            const nameDisplay = file.hidden ? 
                `<span style="opacity: 0.7; font-style: italic;">${file.name}</span>` : 
                file.name;
            
            row.innerHTML = `
                <td>${nameDisplay}</td>
                <td>${sizeKB} KB</td>
                <td>${modified}</td>
                <td>
                    <button class="btn btn-small" onclick="downloadFile('${file.name}')">Download</button>
                    <button class="btn btn-danger btn-small" onclick="deleteFile('${file.name}')">Delete</button>
                </td>
            `;
            
            // Add visual indicator for hidden files
            if (file.hidden) {
                row.style.backgroundColor = 'rgba(255, 255, 255, 0.02)';
            }
        });
    } catch (error) {
        console.error('Error loading files:', error);
        document.getElementById('filesTableBody').innerHTML = 
            '<tr><td colspan="4">Error loading files</td></tr>';
    }
}

    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const response = await fetch(`${API_URL}/monitor/upload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: authToken,
                        filename: file.name,
                        content: e.target.result
                    })
                });
                
                const result = await response.json();
                if (response.ok) {
                    alert(`File ${file.name} uploaded successfully`);
                    loadFiles();
                    fileInput.value = '';
                    document.getElementById('fileUploadText').textContent = 'Or drag and drop a file here';
                    document.getElementById('uploadBtn').style.display = 'none';
                } else {
                    alert('Upload failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Upload error: ' + error.message);
            }
        };
        reader.readAsText(file);
    }

    async function deleteFile(filename) {
        const isEssential = ['visits.csv', 'queries-reisig.csv', 'ip-cache.csv'].includes(filename);
        const message = isEssential 
            ? `Delete ${filename}? This will clear all data and the file will be recreated empty.`
            : `Delete ${filename}?`;
            
        if (!confirm(message)) return;
        
        try {
            const response = await fetch(`${API_URL}/monitor/file/${filename}?token=${authToken}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('File deleted successfully');
                loadFiles();
            } else {
                const error = await response.json();
                alert('Delete failed: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Delete error: ' + error.message);
        }
    }

    function downloadFile(filename) {
        window.open(`${API_URL}/monitor/download/${filename}?token=${authToken}`, '_blank');
    }

    window.addEventListener('load', () => {
        filteredData = allData;
    });
</script>

</body>
</html>
